<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Discord Monitor - Surveillance de Canal</title>
    <meta name="description" content="Surveillez les messages de votre canal Discord en temps réel avec une interface web moderne et intuitive.">
    
    <!-- Styles externes -->
    <link rel="stylesheet" href="style_v2.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <!-- Scripts externes -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <header class="app-header">
            <h1><i class="fab fa-discord" aria-hidden="true"></i> Discord Monitor</h1>
            <p>Surveillance en temps réel de votre canal Discord</p>
        </header>

        <!-- Zone principale de contrôle -->
        <main class="app-main">
            <div class="control-zone">
                <!-- Indicateur de statut et bouton config -->
                <div class="control-header">
                    <div class="status-indicator" id="status-indicator" role="status" aria-live="polite">
                        <span class="status-dot status-dot--disconnected"></span>
                        <span class="status-text">Non configuré</span>
                    </div>
                    
                    <div class="control-buttons">
                        <button class="update-button" id="update-button" aria-label="Mettre à jour l'application">
                            <i class="fas fa-download" aria-hidden="true"></i>
                            <span class="update-count" id="update-count" style="display: none;">0</span>
                        </button>
                        
                        <button class="config-button" id="config-button" aria-label="Ouvrir la configuration">
                            <i class="fas fa-cog" aria-hidden="true"></i>
                            <span>Configuration</span>
                        </button>
                    </div>
                </div>

                <!-- Bouton principal (Hero Button) -->
                <div class="hero-section">
                    <button class="hero-button hero-button--configure" id="hero-button" aria-describedby="hero-description">
                        <div class="hero-button__icon">
                            <i class="fas fa-cog" aria-hidden="true"></i>
                        </div>
                        <div class="hero-button__text">
                            <span class="hero-button__title">Configurer Discord Monitor</span>
                            <span class="hero-button__subtitle">Commencez par configurer votre bot Discord</span>
                        </div>
                    </button>
                    
                    <p class="hero-description" id="hero-description">
                        Cliquez pour configurer votre bot Discord et commencer la surveillance
                    </p>
                </div>

                <!-- Logs compacts -->
                <div class="logs-compact" id="logs-compact">
                    <h3 class="logs-compact__title">
                        <i class="fas fa-history" aria-hidden="true"></i>
                        Activité récente
                    </h3>
                    <div class="logs-compact__content" id="logs-content" role="log" aria-live="polite">
                        <div class="log-entry log-entry--info">
                            <span class="log-time">[${new Date().toLocaleTimeString('fr-FR')}]</span>
                            <span class="log-message">Application démarrée - Configuration requise</span>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Section des messages -->
        <section class="messages-section" aria-labelledby="messages-title">
            <div class="messages-header">
                <h2 id="messages-title">
                    <i class="fas fa-comments" aria-hidden="true"></i>
                    Messages en Temps Réel
                </h2>
                <div class="messages-stats">
                    <span id="message-count" class="message-count">0 messages</span>
                    <span id="connection-status" class="connection-status">Hors ligne</span>
                </div>
            </div>
            
            <div class="messages-container" id="messages-container">
                <div class="no-messages" id="no-messages">
                    <div class="no-messages__icon">
                        <i class="fas fa-comment-slash" aria-hidden="true"></i>
                    </div>
                    <h3>Aucun message reçu</h3>
                    <p>Configurez et démarrez le bot pour commencer la surveillance des messages Discord</p>
                </div>
            </div>
        </section>

        <!-- Modal de configuration -->
        <div class="config-modal" id="config-modal" role="dialog" aria-labelledby="config-modal-title" aria-hidden="true">
            <div class="config-modal__backdrop" id="config-modal-backdrop"></div>
            <div class="config-modal__content">
                <div class="config-modal__header">
                    <h2 id="config-modal-title">
                        <i class="fas fa-cog" aria-hidden="true"></i>
                        Configuration Discord
                    </h2>
                    <button class="config-modal__close" id="config-modal-close" aria-label="Fermer la configuration">
                        <i class="fas fa-times" aria-hidden="true"></i>
                    </button>
                </div>

                <div class="config-modal__body">
                    <div id="config-alerts" role="alert" aria-live="polite"></div>

                    <form id="config-form" class="config-form" novalidate>
                        <div class="form-group">
                            <label for="token" class="form-label">
                                <i class="fas fa-key" aria-hidden="true"></i>
                                Token du Bot Discord
                            </label>
                            <input 
                                type="password" 
                                id="token" 
                                name="token"
                                class="form-input"
                                placeholder="Votre token de bot Discord"
                                autocomplete="off"
                                aria-describedby="token-help"
                                required>
                            <div class="form-help" id="token-help">
                                <i class="fas fa-info-circle" aria-hidden="true"></i>
                                Créez un bot sur <a href="https://discord.com/developers/applications" target="_blank" rel="noopener noreferrer">Discord Developer Portal</a>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="guild-id" class="form-label">
                                <i class="fas fa-server" aria-hidden="true"></i>
                                ID du Serveur Discord
                            </label>
                            <input 
                                type="text" 
                                id="guild-id" 
                                name="guild-id"
                                class="form-input"
                                placeholder="123456789012345678"
                                pattern="[0-9]{17,19}"
                                aria-describedby="guild-help"
                                required>
                            <div class="form-help" id="guild-help">
                                <i class="fas fa-info-circle" aria-hidden="true"></i>
                                Clic droit sur votre serveur → Copier l'ID
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="channel-id" class="form-label">
                                <i class="fas fa-hashtag" aria-hidden="true"></i>
                                ID du Canal à Surveiller
                            </label>
                            <input 
                                type="text" 
                                id="channel-id" 
                                name="channel-id"
                                class="form-input"
                                placeholder="123456789012345678"
                                pattern="[0-9]{17,19}"
                                aria-describedby="channel-help"
                                required>
                            <div class="form-help" id="channel-help">
                                <i class="fas fa-info-circle" aria-hidden="true"></i>
                                Clic droit sur le canal → Copier l'ID
                            </div>
                        </div>

                        <!-- Configuration des Messages -->
                        <div class="form-section">
                            <h3 class="form-section-title">
                                <i class="fas fa-comments" aria-hidden="true"></i>
                                Configuration des Messages
                            </h3>
                            
                            <div class="form-group">
                                <label for="fetch-mode" class="form-label">
                                    <i class="fas fa-download" aria-hidden="true"></i>
                                    Mode de récupération
                                </label>
                                <select id="fetch-mode" name="fetch-mode" class="form-select" aria-describedby="fetch-mode-help">
                                    <option value="latest">Dernier message uniquement</option>
                                    <option value="history">Historique complet</option>
                                </select>
                                <div class="form-help" id="fetch-mode-help">
                                    <i class="fas fa-info-circle" aria-hidden="true"></i>
                                    Choisissez si vous voulez récupérer seulement les nouveaux messages ou tout l'historique
                                </div>
                            </div>

                            <div class="form-group" id="history-options" style="display: none;">
                                <label for="fetch-limit" class="form-label">
                                    <i class="fas fa-list-ol" aria-hidden="true"></i>
                                    Limite de messages
                                </label>
                                <select id="fetch-limit" name="fetch-limit" class="form-select">
                                    <option value="50">50 messages</option>
                                    <option value="100">100 messages</option>
                                    <option value="500">500 messages</option>
                                    <option value="1000">1000 messages</option>
                                    <option value="unlimited">Illimité</option>
                                </select>
                            </div>

                            <div class="form-group" id="period-options" style="display: none;">
                                <label for="fetch-period" class="form-label">
                                    <i class="fas fa-calendar-alt" aria-hidden="true"></i>
                                    Période
                                </label>
                                <select id="fetch-period" name="fetch-period" class="form-select">
                                    <option value="24h">Dernières 24 heures</option>
                                    <option value="7d">7 derniers jours</option>
                                    <option value="30d">30 derniers jours</option>
                                    <option value="all">Tout l'historique</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label class="form-checkbox">
                                    <input type="checkbox" id="dangerous-actions" name="dangerous-actions">
                                    <span class="form-checkbox-mark"></span>
                                    <span class="form-checkbox-label">
                                        <i class="fas fa-exclamation-triangle" aria-hidden="true"></i>
                                        Activer les actions dangereuses
                                    </span>
                                </label>
                                <div class="form-help">
                                    <i class="fas fa-warning" aria-hidden="true"></i>
                                    ⚠️ Permet la suppression de tous les messages du canal
                                </div>
                            </div>
                        </div>

                        <!-- Zone Dangereuse -->
                        <div class="form-section danger-zone" id="danger-zone" style="display: none;">
                            <h3 class="form-section-title danger-title">
                                <i class="fas fa-skull-crossbones" aria-hidden="true"></i>
                                🚨 Zone Dangereuse
                            </h3>
                            
                            <div class="danger-actions">
                                <button type="button" class="btn btn--danger" id="delete-all-messages">
                                    <i class="fas fa-trash-alt" aria-hidden="true"></i>
                                    Supprimer tous les messages
                                </button>
                                <div class="form-help danger-help">
                                    <i class="fas fa-exclamation-triangle" aria-hidden="true"></i>
                                    Cette action est <strong>irréversible</strong> ! Une sauvegarde sera créée automatiquement.
                                </div>
                            </div>
                        </div>

                        <div class="config-modal__actions">
                            <button type="button" class="btn btn--secondary" id="config-cancel">
                                <i class="fas fa-times" aria-hidden="true"></i>
                                Annuler
                            </button>
                            <button type="submit" class="btn btn--primary" id="config-save">
                                <i class="fas fa-save" aria-hidden="true"></i>
                                Sauvegarder
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Overlay de chargement -->
        <div class="loading-overlay" id="loading-overlay" aria-hidden="true">
            <div class="loading-spinner">
                <div class="spinner"></div>
                <p id="loading-text">Connexion en cours...</p>
            </div>
        </div>
    </div>

    <script>
        // État global de l'application
        const AppState = {
            // États possibles: 'not-configured', 'configured', 'connecting', 'connected', 'error'
            currentState: 'not-configured',
            isConfigured: false,
            socket: null,
            messageCount: 0,
            
            // Éléments DOM
            elements: {
                heroButton: null,
                statusIndicator: null,
                configModal: null,
                configButton: null,
                logsContent: null,
                messagesContainer: null,
                messageCount: null,
                connectionStatus: null,
                loadingOverlay: null
            },

            // Initialisation
            init() {
                this.cacheElements();
                this.initializeSocket();
                this.setupEventListeners();
                this.loadConfiguration();
            },

            // Cache des éléments DOM
            cacheElements() {
                this.elements.heroButton = document.getElementById('hero-button');
                this.elements.statusIndicator = document.getElementById('status-indicator');
                this.elements.configModal = document.getElementById('config-modal');
                this.elements.configButton = document.getElementById('config-button');
                this.elements.updateButton = document.getElementById('update-button');
                this.elements.updateCount = document.getElementById('update-count');
                this.elements.logsContent = document.getElementById('logs-content');
                this.elements.messagesContainer = document.getElementById('messages-container');
                this.elements.messageCount = document.getElementById('message-count');
                this.elements.connectionStatus = document.getElementById('connection-status');
                this.elements.loadingOverlay = document.getElementById('loading-overlay');
                
                // Nouveaux éléments pour la configuration des messages
                this.elements.fetchModeSelect = document.getElementById('fetch-mode');
                this.elements.fetchLimitSelect = document.getElementById('fetch-limit');
                this.elements.fetchPeriodSelect = document.getElementById('fetch-period');
                this.elements.dangerousActionsCheckbox = document.getElementById('dangerous-actions');
                this.elements.historyOptions = document.getElementById('history-options');
                this.elements.periodOptions = document.getElementById('period-options');
                this.elements.dangerZone = document.getElementById('danger-zone');
                this.elements.deleteAllMessagesButton = document.getElementById('delete-all-messages');
            },

            // Configuration Socket.IO
            initializeSocket() {
                this.socket = io();
                
                this.socket.on('connect', () => {
                    this.addLog('Connexion WebSocket établie', 'success');
                });

                this.socket.on('disconnect', () => {
                    this.addLog('Connexion WebSocket fermée', 'error');
                });

                this.socket.on('new_message', (data) => {
                    this.addMessage(data);
                });

                this.socket.on('status_change', (data) => {
                    this.updateState(data.status);
                    this.addLog(data.message, data.status === 'error' ? 'error' : 'success');
                });
            },

            // Configuration des événements
            setupEventListeners() {
                // Bouton principal
                this.elements.heroButton.addEventListener('click', () => this.handleHeroButtonClick());
                
                // Bouton de configuration
                this.elements.configButton.addEventListener('click', () => this.openConfigModal());
                
                // Bouton de mise à jour
                this.elements.updateButton.addEventListener('click', () => this.handleUpdateClick());
                
                // Modal de configuration
                document.getElementById('config-modal-close').addEventListener('click', () => this.closeConfigModal());
                document.getElementById('config-modal-backdrop').addEventListener('click', () => this.closeConfigModal());
                document.getElementById('config-cancel').addEventListener('click', () => this.closeConfigModal());
                document.getElementById('config-form').addEventListener('submit', (e) => this.handleConfigSubmit(e));
                
                // Nouveaux événements pour la configuration des messages
                if (this.elements.fetchModeSelect) {
                    this.elements.fetchModeSelect.addEventListener('change', () => this.handleFetchModeChange());
                }
                
                if (this.elements.dangerousActionsCheckbox) {
                    this.elements.dangerousActionsCheckbox.addEventListener('change', () => this.handleDangerousActionsChange());
                }
                
                if (this.elements.deleteAllMessagesButton) {
                    this.elements.deleteAllMessagesButton.addEventListener('click', () => this.handleDeleteAllMessages());
                }
                
                // Gestion du clavier pour la modal
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape' && !this.elements.configModal.getAttribute('aria-hidden')) {
                        this.closeConfigModal();
                    }
                });
                
                // Vérifier les mises à jour périodiquement
                this.checkForUpdates();
                setInterval(() => this.checkForUpdates(), 300000); // Toutes les 5 minutes
            },

            // Gestion du clic sur le bouton principal
            handleHeroButtonClick() {
                switch (this.currentState) {
                    case 'not-configured':
                        this.openConfigModal();
                        break;
                    case 'configured':
                        this.startListening();
                        break;
                    case 'connected':
                        this.stopListening();
                        break;
                    default:
                        // États transitoires, ne rien faire
                        break;
                }
            },

            // Mise à jour de l'état de l'application
            updateState(newState) {
                this.currentState = newState;
                this.updateUI();
            },

            // Mise à jour de l'interface utilisateur
            updateUI() {
                this.updateHeroButton();
                this.updateStatusIndicator();
                this.updateConnectionStatus();
            },

            // Mise à jour du bouton principal
            updateHeroButton() {
                const button = this.elements.heroButton;
                const icon = button.querySelector('.hero-button__icon i');
                const title = button.querySelector('.hero-button__title');
                const subtitle = button.querySelector('.hero-button__subtitle');

                // Supprimer toutes les classes d'état
                button.className = 'hero-button';

                switch (this.currentState) {
                    case 'not-configured':
                        button.classList.add('hero-button--configure');
                        icon.className = 'fas fa-cog';
                        title.textContent = 'Configurer Discord Monitor';
                        subtitle.textContent = 'Commencez par configurer votre bot Discord';
                        button.disabled = false;
                        break;
                    
                    case 'configured':
                        button.classList.add('hero-button--start');
                        icon.className = 'fas fa-play';
                        title.textContent = 'Démarrer l\'écoute';
                        subtitle.textContent = 'Commencer la surveillance des messages';
                        button.disabled = false;
                        break;
                    
                    case 'connecting':
                        button.classList.add('hero-button--connecting');
                        icon.className = 'fas fa-spinner fa-spin';
                        title.textContent = 'Connexion en cours...';
                        subtitle.textContent = 'Connexion au serveur Discord';
                        button.disabled = true;
                        break;
                    
                    case 'connected':
                        button.classList.add('hero-button--stop');
                        icon.className = 'fas fa-stop';
                        title.textContent = 'Arrêter l\'écoute';
                        subtitle.textContent = 'Surveillance active - Cliquez pour arrêter';
                        button.disabled = false;
                        break;
                    
                    case 'error':
                        button.classList.add('hero-button--error');
                        icon.className = 'fas fa-exclamation-triangle';
                        title.textContent = 'Erreur de connexion';
                        subtitle.textContent = 'Cliquez pour réessayer';
                        button.disabled = false;
                        break;
                }
            },

            // Mise à jour de l'indicateur de statut
            updateStatusIndicator() {
                const indicator = this.elements.statusIndicator;
                const dot = indicator.querySelector('.status-dot');
                const text = indicator.querySelector('.status-text');

                // Supprimer toutes les classes d'état
                dot.className = 'status-dot';

                switch (this.currentState) {
                    case 'not-configured':
                        dot.classList.add('status-dot--disconnected');
                        text.textContent = 'Non configuré';
                        break;
                    
                    case 'configured':
                        dot.classList.add('status-dot--ready');
                        text.textContent = 'Prêt à démarrer';
                        break;
                    
                    case 'connecting':
                        dot.classList.add('status-dot--connecting');
                        text.textContent = 'Connexion...';
                        break;
                    
                    case 'connected':
                        dot.classList.add('status-dot--connected');
                        text.textContent = 'En écoute active';
                        break;
                    
                    case 'error':
                        dot.classList.add('status-dot--error');
                        text.textContent = 'Erreur';
                        break;
                }
            },

            // Mise à jour du statut de connexion
            updateConnectionStatus() {
                const status = this.elements.connectionStatus;
                
                switch (this.currentState) {
                    case 'connected':
                        status.textContent = 'En ligne';
                        status.className = 'connection-status connection-status--online';
                        break;
                    case 'connecting':
                        status.textContent = 'Connexion...';
                        status.className = 'connection-status connection-status--connecting';
                        break;
                    default:
                        status.textContent = 'Hors ligne';
                        status.className = 'connection-status connection-status--offline';
                        break;
                }
            },

            // Ouverture de la modal de configuration
            openConfigModal() {
                this.elements.configModal.setAttribute('aria-hidden', 'false');
                this.elements.configModal.classList.add('config-modal--open');
                
                // Focus sur le premier champ
                const firstInput = this.elements.configModal.querySelector('input');
                if (firstInput) {
                    setTimeout(() => firstInput.focus(), 100);
                }
                
                // Empêcher le scroll du body
                document.body.style.overflow = 'hidden';
            },

            // Fermeture de la modal de configuration
            closeConfigModal() {
                this.elements.configModal.setAttribute('aria-hidden', 'true');
                this.elements.configModal.classList.remove('config-modal--open');
                
                // Restaurer le scroll du body
                document.body.style.overflow = '';
                
                // Remettre le focus sur le bouton qui a ouvert la modal
                this.elements.configButton.focus();
            },

            // Gestion de la soumission du formulaire de configuration
            async handleConfigSubmit(event) {
                event.preventDefault();
                
                const formData = new FormData(event.target);
                const token = formData.get('token').trim();
                const guildId = formData.get('guild-id').trim();
                const channelId = formData.get('channel-id').trim();

                if (!token || !guildId || !channelId) {
                    this.showConfigAlert('Tous les champs sont requis', 'error');
                    return;
                }

                try {
                    this.showLoading('Sauvegarde de la configuration...');
                    
                    const response = await fetch('/api/discord/config', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            token: token,
                            guild_id: guildId,
                            channel_id: channelId
                        })
                    });

                    const result = await response.json();

                    if (response.ok) {
                        this.showConfigAlert('Configuration sauvegardée avec succès', 'success');
                        this.isConfigured = true;
                        this.updateState('configured');
                        this.addLog('Configuration sauvegardée', 'success');
                        
                        setTimeout(() => {
                            this.closeConfigModal();
                        }, 1500);
                    } else {
                        this.showConfigAlert(result.error || 'Erreur lors de la sauvegarde', 'error');
                    }
                } catch (error) {
                    this.showConfigAlert('Erreur de connexion', 'error');
                    this.addLog('Erreur: ' + error.message, 'error');
                } finally {
                    this.hideLoading();
                }
            },

            // Démarrage de l'écoute
            async startListening() {
                if (!this.isConfigured) {
                    this.openConfigModal();
                    return;
                }

                try {
                    this.updateState('connecting');
                    this.showLoading('Connexion au serveur Discord...');
                    this.addLog('Démarrage de l\'écoute...', 'info');

                    const response = await fetch('/api/discord/start', {
                        method: 'POST'
                    });

                    const result = await response.json();

                    if (response.ok) {
                        this.updateState('connected');
                        this.addLog('Écoute démarrée avec succès', 'success');
                    } else {
                        this.updateState('error');
                        this.addLog(result.error || 'Erreur lors du démarrage', 'error');
                    }
                } catch (error) {
                    this.updateState('error');
                    this.addLog('Erreur de connexion: ' + error.message, 'error');
                } finally {
                    this.hideLoading();
                }
            },

            // Arrêt de l'écoute
            async stopListening() {
                try {
                    this.showLoading('Arrêt de l\'écoute...');

                    const response = await fetch('/api/discord/stop', {
                        method: 'POST'
                    });

                    const result = await response.json();

                    if (response.ok) {
                        this.updateState('configured');
                        this.addLog('Écoute arrêtée', 'info');
                    } else {
                        this.addLog(result.error || 'Erreur lors de l\'arrêt', 'error');
                    }
                } catch (error) {
                    this.addLog('Erreur de connexion: ' + error.message, 'error');
                } finally {
                    this.hideLoading();
                }
            },

            // Chargement de la configuration
            async loadConfiguration() {
                try {
                    const response = await fetch('/api/discord/config');
                    const config = await response.json();
                    
                    if (config.guild_id) {
                        document.getElementById('guild-id').value = config.guild_id;
                    }
                    if (config.channel_id) {
                        document.getElementById('channel-id').value = config.channel_id;
                    }
                    
                    this.isConfigured = config.token_configured;
                    
                    if (this.isConfigured) {
                        this.updateState('configured');
                        this.addLog('Configuration chargée', 'success');
                    } else {
                        this.updateState('not-configured');
                        this.addLog('Configuration requise', 'info');
                    }
                    
                    // Charger aussi la configuration des messages
                    await this.loadMessagesConfig();
                    
                } catch (error) {
                    this.addLog('Erreur lors du chargement de la configuration', 'error');
                }
            },

            // Ajout d'un message
            addMessage(messageData) {
                const container = this.elements.messagesContainer;
                
                // Supprimer le message "aucun message" s'il existe
                const noMessages = container.querySelector('#no-messages');
                if (noMessages) {
                    noMessages.remove();
                }

                // Créer l'élément message
                const messageElement = document.createElement('div');
                messageElement.className = 'message';
                messageElement.setAttribute('role', 'article');
                
                const avatar = messageData.author.avatar_url 
                    ? `<img src="${messageData.author.avatar_url}" alt="Avatar de ${messageData.author.name}" class="message__avatar">`
                    : `<div class="message__avatar message__avatar--text">${messageData.author.name.charAt(0).toUpperCase()}</div>`;

                const timestamp = new Date(messageData.timestamp).toLocaleString('fr-FR');

                messageElement.innerHTML = `
                    ${avatar}
                    <div class="message__content">
                        <div class="message__header">
                            <span class="message__author">${this.escapeHtml(messageData.author.name)}</span>
                            <time class="message__time" datetime="${messageData.timestamp}">${timestamp}</time>
                        </div>
                        <div class="message__text">${this.escapeHtml(messageData.content) || '<em>Message sans texte</em>'}</div>
                        ${messageData.attachments.length > 0 ? `
                            <div class="message__attachments">
                                ${messageData.attachments.map(att => `
                                    <div class="message__attachment">
                                        <i class="fas fa-paperclip" aria-hidden="true"></i>
                                        ${this.escapeHtml(att.filename)}
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                `;

                // Ajouter en haut de la liste
                container.insertBefore(messageElement, container.firstChild);

                // Limiter le nombre de messages affichés
                const messages = container.querySelectorAll('.message');
                if (messages.length > 50) {
                    messages[messages.length - 1].remove();
                }

                // Mettre à jour le compteur
                this.messageCount++;
                this.elements.messageCount.textContent = `${this.messageCount} message${this.messageCount > 1 ? 's' : ''}`;
            },

            // Ajout d'un log
            addLog(message, type = 'info') {
                const container = this.elements.logsContent;
                const timestamp = new Date().toLocaleTimeString('fr-FR');
                
                const logEntry = document.createElement('div');
                logEntry.className = `log-entry log-entry--${type}`;
                logEntry.innerHTML = `
                    <span class="log-time">[${timestamp}]</span>
                    <span class="log-message">${this.escapeHtml(message)}</span>
                `;

                container.insertBefore(logEntry, container.firstChild);

                // Limiter le nombre de logs
                const logs = container.children;
                if (logs.length > 10) {
                    logs[logs.length - 1].remove();
                }
            },

            // Affichage d'une alerte dans la modal de configuration
            showConfigAlert(message, type) {
                const alertsContainer = document.getElementById('config-alerts');
                const alert = document.createElement('div');
                alert.className = `alert alert--${type}`;
                alert.setAttribute('role', 'alert');
                
                const icon = type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-triangle' : 'info-circle';
                alert.innerHTML = `
                    <i class="fas fa-${icon}" aria-hidden="true"></i>
                    <span>${this.escapeHtml(message)}</span>
                `;

                alertsContainer.appendChild(alert);

                // Supprimer l'alerte après 5 secondes
                setTimeout(() => {
                    alert.remove();
                }, 5000);
            },

            // Affichage de l'overlay de chargement
            showLoading(text = 'Chargement...') {
                this.elements.loadingOverlay.setAttribute('aria-hidden', 'false');
                this.elements.loadingOverlay.classList.add('loading-overlay--visible');
                document.getElementById('loading-text').textContent = text;
            },

            // Masquage de l'overlay de chargement
            hideLoading() {
                this.elements.loadingOverlay.setAttribute('aria-hidden', 'true');
                this.elements.loadingOverlay.classList.remove('loading-overlay--visible');
            },

            // Vérification des mises à jour disponibles
            async checkForUpdates() {
                try {
                    const response = await fetch('/api/discord/update/status');
                    const updateStatus = await response.json();
                    
                    if (updateStatus.git_available && updateStatus.auto_update_enabled) {
                        // Toujours afficher le bouton
                        this.elements.updateButton.style.display = 'flex';
                        
                        if (updateStatus.updates_available > 0) {
                            // Des mises à jour sont disponibles
                            this.elements.updateButton.classList.remove('update-button--up-to-date');
                            this.elements.updateButton.classList.add('update-button--available');
                            this.elements.updateCount.style.display = 'flex';
                            this.elements.updateCount.textContent = updateStatus.updates_available;
                            this.elements.updateButton.title = `${updateStatus.updates_available} mise(s) à jour disponible(s) - Cliquez pour mettre à jour`;
                            this.elements.updateButton.disabled = false;
                        } else {
                            // Aucune mise à jour disponible
                            this.elements.updateButton.classList.remove('update-button--available');
                            this.elements.updateButton.classList.add('update-button--up-to-date');
                            this.elements.updateCount.style.display = 'none';
                            this.elements.updateButton.title = 'Application à jour - Cliquez pour vérifier les mises à jour';
                            this.elements.updateButton.disabled = false;
                        }
                    } else {
                        // Git non disponible ou mises à jour désactivées
                        this.elements.updateButton.style.display = 'flex';
                        this.elements.updateButton.classList.remove('update-button--available', 'update-button--up-to-date');
                        this.elements.updateButton.classList.add('update-button--disabled');
                        this.elements.updateCount.style.display = 'none';
                        this.elements.updateButton.title = 'Mises à jour non disponibles (Git manquant ou désactivé)';
                        this.elements.updateButton.disabled = true;
                    }
                } catch (error) {
                    console.log('Erreur lors de la vérification des mises à jour:', error);
                    // Afficher le bouton en état d'erreur
                    this.elements.updateButton.style.display = 'flex';
                    this.elements.updateButton.classList.remove('update-button--available', 'update-button--up-to-date');
                    this.elements.updateButton.classList.add('update-button--error');
                    this.elements.updateCount.style.display = 'none';
                    this.elements.updateButton.title = 'Erreur lors de la vérification des mises à jour';
                    this.elements.updateButton.disabled = true;
                }
            },

            // Gestion du clic sur le bouton de mise à jour
            async handleUpdateClick() {
                // Si le bouton est désactivé, ne rien faire
                if (this.elements.updateButton.disabled) {
                    return;
                }

                // Si aucune mise à jour n'est disponible, forcer une vérification
                if (this.elements.updateButton.classList.contains('update-button--up-to-date')) {
                    this.addLog('Vérification forcée des mises à jour...', 'info');
                    await this.checkForUpdates();
                    
                    // Si toujours aucune mise à jour après vérification
                    if (this.elements.updateButton.classList.contains('update-button--up-to-date')) {
                        this.addLog('Aucune mise à jour disponible', 'info');
                        return;
                    }
                }

                if (!confirm('Êtes-vous sûr de vouloir mettre à jour l\'application ?\n\nCela va :\n• Arrêter le bot Discord\n• Mettre à jour le code\n• Redémarrer le service complet\n\nLe processus prend environ 30 secondes.')) {
                    return;
                }

                try {
                    this.showLoading('Mise à jour en cours...');
                    this.addLog('Démarrage de la mise à jour...', 'info');
                    
                    // Désactiver le bouton pendant la mise à jour
                    this.elements.updateButton.disabled = true;

                    const response = await fetch('/api/discord/update', {
                        method: 'POST'
                    });

                    const result = await response.json();

                    if (response.ok) {
                        this.addLog('Mise à jour effectuée avec succès', 'success');
                        
                        if (result.service_restart) {
                            this.addLog('Redémarrage du service en cours...', 'info');
                            this.showLoading('Redémarrage du service...');
                            
                            // Attendre un peu puis essayer de reconnecter
                            setTimeout(() => {
                                this.addLog('Tentative de reconnexion...', 'info');
                                this.attemptReconnection();
                            }, 5000);
                        } else {
                            // Recharger la page après un délai si pas de redémarrage
                            setTimeout(() => {
                                this.addLog('Rechargement de la page...', 'info');
                                window.location.reload();
                            }, 2000);
                        }
                    } else {
                        this.addLog(result.error || 'Erreur lors de la mise à jour', 'error');
                        this.elements.updateButton.disabled = false;
                        this.hideLoading();
                    }
                } catch (error) {
                    this.addLog('Erreur de connexion lors de la mise à jour: ' + error.message, 'error');
                    this.elements.updateButton.disabled = false;
                    this.hideLoading();
                }
            },

            // Tentative de reconnexion après redémarrage du service
            async attemptReconnection(maxAttempts = 10, currentAttempt = 1) {
                try {
                    this.addLog(`Tentative de reconnexion ${currentAttempt}/${maxAttempts}...`, 'info');
                    
                    // Tester si le serveur répond
                    const response = await fetch('/api/discord/status', {
                        method: 'GET',
                        timeout: 5000
                    });
                    
                    if (response.ok) {
                        this.addLog('Reconnexion réussie ! Rechargement de la page...', 'success');
                        setTimeout(() => {
                            window.location.reload();
                        }, 1000);
                        return;
                    }
                } catch (error) {
                    // Le serveur n'est pas encore prêt
                }
                
                if (currentAttempt < maxAttempts) {
                    // Attendre avant la prochaine tentative (délai croissant)
                    const delay = Math.min(2000 + (currentAttempt * 1000), 10000);
                    setTimeout(() => {
                        this.attemptReconnection(maxAttempts, currentAttempt + 1);
                    }, delay);
                } else {
                    this.addLog('Impossible de se reconnecter automatiquement. Veuillez recharger la page manuellement.', 'error');
                    this.hideLoading();
                    
                    // Afficher un bouton de rechargement manuel
                    const reloadButton = document.createElement('button');
                    reloadButton.textContent = 'Recharger la page';
                    reloadButton.className = 'hero-button hero-button--error';
                    reloadButton.onclick = () => window.location.reload();
                    
                    const heroSection = document.querySelector('.hero-section');
                    if (heroSection) {
                        heroSection.innerHTML = '';
                        heroSection.appendChild(reloadButton);
                    }
                }
            },

            // Gestion du changement de mode de récupération
            handleFetchModeChange() {
                const mode = this.elements.fetchModeSelect.value;
                const historyOptions = this.elements.historyOptions;
                const periodOptions = this.elements.periodOptions;
                
                if (mode === 'history') {
                    historyOptions.style.display = 'block';
                    periodOptions.style.display = 'block';
                } else {
                    historyOptions.style.display = 'none';
                    periodOptions.style.display = 'none';
                }
            },

            // Gestion du changement d'actions dangereuses
            handleDangerousActionsChange() {
                const enabled = this.elements.dangerousActionsCheckbox.checked;
                const dangerZone = this.elements.dangerZone;
                
                if (enabled) {
                    dangerZone.style.display = 'block';
                } else {
                    dangerZone.style.display = 'none';
                }
            },

            // Gestion de la suppression de tous les messages
            async handleDeleteAllMessages() {
                // Créer et afficher la modal de confirmation critique
                const modal = this.createCriticalConfirmationModal();
                document.body.appendChild(modal);
                
                // Récupérer le nom du canal pour la confirmation
                try {
                    const statsResponse = await fetch('/api/discord/messages/stats');
                    const stats = await statsResponse.json();
                    const channelName = stats.channel_name || 'canal-inconnu';
                    
                    modal.querySelector('#critical-channel-name').textContent = channelName;
                    modal.querySelector('#channel-name-input').setAttribute('data-expected', channelName);
                } catch (error) {
                    this.addLog('Erreur lors de la récupération du nom du canal', 'error');
                    document.body.removeChild(modal);
                    return;
                }
            },

            // Création de la modal de confirmation critique
            createCriticalConfirmationModal() {
                const modal = document.createElement('div');
                modal.className = 'critical-modal';
                modal.innerHTML = `
                    <div class="critical-modal__content">
                        <div class="critical-modal__header">
                            <h2 class="critical-modal__title">
                                <i class="fas fa-skull-crossbones"></i>
                                Action Critique
                            </h2>
                        </div>
                        
                        <div class="critical-modal__warning">
                            <strong>⚠️ ATTENTION !</strong><br>
                            Vous êtes sur le point de supprimer <strong>TOUS les messages</strong> du canal <strong id="critical-channel-name"></strong>.<br><br>
                            Cette action est <strong>IRRÉVERSIBLE</strong> !<br>
                            Une sauvegarde sera créée automatiquement.
                        </div>
                        
                        <div>
                            <label for="confirmation-input">Tapez <strong>DELETE ALL MESSAGES</strong> pour confirmer :</label>
                            <input type="text" id="confirmation-input" class="critical-modal__input" placeholder="DELETE ALL MESSAGES">
                        </div>
                        
                        <div>
                            <label for="channel-name-input">Tapez le nom exact du canal pour confirmer :</label>
                            <input type="text" id="channel-name-input" class="critical-modal__input" placeholder="nom-du-canal">
                        </div>
                        
                        <div class="critical-modal__actions">
                            <button type="button" class="btn btn--secondary" id="critical-cancel">
                                <i class="fas fa-times"></i>
                                Annuler
                            </button>
                            <button type="button" class="btn btn--danger" id="critical-confirm" disabled>
                                <i class="fas fa-trash-alt"></i>
                                Supprimer TOUT
                            </button>
                        </div>
                    </div>
                `;
                
                // Ajouter les événements
                const confirmationInput = modal.querySelector('#confirmation-input');
                const channelNameInput = modal.querySelector('#channel-name-input');
                const confirmButton = modal.querySelector('#critical-confirm');
                const cancelButton = modal.querySelector('#critical-cancel');
                
                const validateInputs = () => {
                    const confirmationValid = confirmationInput.value === 'DELETE ALL MESSAGES';
                    const channelNameValid = channelNameInput.value === channelNameInput.getAttribute('data-expected');
                    confirmButton.disabled = !(confirmationValid && channelNameValid);
                };
                
                confirmationInput.addEventListener('input', validateInputs);
                channelNameInput.addEventListener('input', validateInputs);
                
                cancelButton.addEventListener('click', () => {
                    modal.classList.remove('active');
                    setTimeout(() => document.body.removeChild(modal), 300);
                });
                
                confirmButton.addEventListener('click', async () => {
                    await this.executeDeleteAllMessages(modal);
                });
                
                // Afficher la modal
                setTimeout(() => modal.classList.add('active'), 10);
                
                return modal;
            },

            // Exécution de la suppression de tous les messages
            async executeDeleteAllMessages(modal) {
                try {
                    this.showLoading('Suppression de tous les messages en cours...');
                    this.addLog('🗑️ Démarrage de la suppression de tous les messages...', 'warning');
                    
                    const confirmationText = modal.querySelector('#confirmation-input').value;
                    const channelNameConfirmation = modal.querySelector('#channel-name-input').value;
                    
                    const response = await fetch('/api/discord/messages/delete-all', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            confirmation_text: confirmationText,
                            channel_name_confirmation: channelNameConfirmation
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (response.ok) {
                        this.addLog(`✅ Suppression terminée: ${result.deleted_count} messages supprimés`, 'success');
                        this.addLog(`💾 Sauvegarde créée: ${result.backup_file}`, 'info');
                        
                        // Fermer la modal
                        modal.classList.remove('active');
                        setTimeout(() => document.body.removeChild(modal), 300);
                        
                        // Rafraîchir les statistiques
                        this.refreshMessageStats();
                    } else {
                        this.addLog(`❌ Erreur lors de la suppression: ${result.error}`, 'error');
                    }
                } catch (error) {
                    this.addLog(`❌ Erreur de connexion: ${error.message}`, 'error');
                } finally {
                    this.hideLoading();
                }
            },

            // Rafraîchissement des statistiques des messages
            async refreshMessageStats() {
                try {
                    const response = await fetch('/api/discord/messages/stats');
                    const stats = await response.json();
                    
                    if (response.ok) {
                        this.addLog(`📊 Statistiques mises à jour: ${stats.total_messages} messages au total`, 'info');
                    }
                } catch (error) {
                    console.error('Erreur lors du rafraîchissement des stats:', error);
                }
            },

            // Chargement de la configuration des messages
            async loadMessagesConfig() {
                try {
                    const response = await fetch('/api/discord/messages/config');
                    const config = await response.json();
                    
                    if (response.ok) {
                        // Appliquer la configuration à l'interface
                        if (this.elements.fetchModeSelect) {
                            this.elements.fetchModeSelect.value = config.fetch_mode || 'latest';
                            this.handleFetchModeChange();
                        }
                        
                        if (this.elements.fetchLimitSelect) {
                            this.elements.fetchLimitSelect.value = config.fetch_limit || '100';
                        }
                        
                        if (this.elements.fetchPeriodSelect) {
                            this.elements.fetchPeriodSelect.value = config.fetch_period || '7d';
                        }
                        
                        if (this.elements.dangerousActionsCheckbox) {
                            this.elements.dangerousActionsCheckbox.checked = config.dangerous_actions || false;
                            this.handleDangerousActionsChange();
                        }
                    }
                } catch (error) {
                    console.error('Erreur lors du chargement de la config messages:', error);
                }
            },

            // Fonction utilitaire pour échapper le HTML
            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
        };

        // Initialisation de l'application
        document.addEventListener('DOMContentLoaded', () => {
            AppState.init();
        });
    </script>
</body>
</html>

