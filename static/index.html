<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Discord Monitor - Surveillance de Canal</title>
    <meta name="description" content="Surveillez les messages de votre canal Discord en temps réel avec une interface web moderne et intuitive.">
    
    <!-- Styles externes -->
    <link rel="stylesheet" href="style_v2.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <!-- Scripts externes -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <header class="app-header">
            <h1><i class="fab fa-discord" aria-hidden="true"></i> Discord Monitor</h1>
            <p>Surveillance en temps réel de votre canal Discord</p>
        </header>

        <!-- Zone principale de contrôle -->
        <main class="app-main">
            <div class="control-zone">
                <!-- Indicateur de statut et bouton config -->
                <div class="control-header">
                    <div class="status-indicator" id="status-indicator" role="status" aria-live="polite">
                        <span class="status-dot status-dot--disconnected"></span>
                        <span class="status-text">Non configuré</span>
                    </div>
                    
                    <div class="control-buttons">
                        <button class="update-button" id="update-button" aria-label="Mettre à jour l'application">
                            <i class="fas fa-download" aria-hidden="true"></i>
                            <span class="update-count" id="update-count" style="display: none;">0</span>
                        </button>
                        
                        <button class="config-button" id="config-button" aria-label="Ouvrir la configuration">
                            <i class="fas fa-cog" aria-hidden="true"></i>
                            <span>Configuration</span>
                        </button>
                    </div>
                </div>

                <!-- Bouton principal (Hero Button) -->
                <div class="hero-section">
                    <button class="hero-button hero-button--configure" id="hero-button" aria-describedby="hero-description">
                        <div class="hero-button__icon">
                            <i class="fas fa-cog" aria-hidden="true"></i>
                        </div>
                        <div class="hero-button__text">
                            <span class="hero-button__title">Configurer Discord Monitor</span>
                            <span class="hero-button__subtitle">Commencez par configurer votre bot Discord</span>
                        </div>
                    </button>
                    
                    <p class="hero-description" id="hero-description">
                        Cliquez pour configurer votre bot Discord et commencer la surveillance
                    </p>
                </div>

                <!-- Logs compacts -->
                <div class="logs-compact" id="logs-compact">
                    <h3 class="logs-compact__title">
                        <i class="fas fa-history" aria-hidden="true"></i>
                        Activité récente
                    </h3>
                    <div class="logs-compact__content" id="logs-content" role="log" aria-live="polite">
                        <div class="log-entry log-entry--info">
                            <span class="log-time">[${new Date().toLocaleTimeString('fr-FR')}]</span>
                            <span class="log-message">Application démarrée - Configuration requise</span>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Section des messages -->
        <section class="messages-section" aria-labelledby="messages-title">
            <div class="messages-header">
                <h2 id="messages-title">
                    <i class="fas fa-comments" aria-hidden="true"></i>
                    Messages en Temps Réel
                </h2>
                <div class="messages-stats">
                    <span id="message-count" class="message-count">0 messages</span>
                    <span id="connection-status" class="connection-status">Hors ligne</span>
                </div>
            </div>
            
            <div class="messages-container" id="messages-container">
                <div class="no-messages" id="no-messages">
                    <div class="no-messages__icon">
                        <i class="fas fa-comment-slash" aria-hidden="true"></i>
                    </div>
                    <h3>Aucun message reçu</h3>
                    <p>Configurez et démarrez le bot pour commencer la surveillance des messages Discord</p>
                </div>
            </div>
        </section>

        <!-- Modal de configuration -->
        <div class="config-modal" id="config-modal" role="dialog" aria-labelledby="config-modal-title" aria-hidden="true">
            <div class="config-modal__backdrop" id="config-modal-backdrop"></div>
            <div class="config-modal__content">
                <div class="config-modal__header">
                    <h2 id="config-modal-title">
                        <i class="fas fa-cog" aria-hidden="true"></i>
                        Configuration Discord
                    </h2>
                    <button class="config-modal__close" id="config-modal-close" aria-label="Fermer la configuration">
                        <i class="fas fa-times" aria-hidden="true"></i>
                    </button>
                </div>

                <div class="config-modal__body">
                    <div id="config-alerts" role="alert" aria-live="polite"></div>

                    <form id="config-form" class="config-form" novalidate>
                        <div class="form-group">
                            <label for="token" class="form-label">
                                <i class="fas fa-key" aria-hidden="true"></i>
                                Token du Bot Discord
                            </label>
                            <input 
                                type="password" 
                                id="token" 
                                name="token"
                                class="form-input"
                                placeholder="Votre token de bot Discord"
                                autocomplete="off"
                                aria-describedby="token-help"
                                required>
                            <div class="form-help" id="token-help">
                                <i class="fas fa-info-circle" aria-hidden="true"></i>
                                Créez un bot sur <a href="https://discord.com/developers/applications" target="_blank" rel="noopener noreferrer">Discord Developer Portal</a>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="guild-id" class="form-label">
                                <i class="fas fa-server" aria-hidden="true"></i>
                                ID du Serveur Discord
                            </label>
                            <input 
                                type="text" 
                                id="guild-id" 
                                name="guild-id"
                                class="form-input"
                                placeholder="123456789012345678"
                                pattern="[0-9]{17,19}"
                                aria-describedby="guild-help"
                                required>
                            <div class="form-help" id="guild-help">
                                <i class="fas fa-info-circle" aria-hidden="true"></i>
                                Clic droit sur votre serveur → Copier l'ID
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="channel-id" class="form-label">
                                <i class="fas fa-hashtag" aria-hidden="true"></i>
                                ID du Canal à Surveiller
                            </label>
                            <input 
                                type="text" 
                                id="channel-id" 
                                name="channel-id"
                                class="form-input"
                                placeholder="123456789012345678"
                                pattern="[0-9]{17,19}"
                                aria-describedby="channel-help"
                                required>
                            <div class="form-help" id="channel-help">
                                <i class="fas fa-info-circle" aria-hidden="true"></i>
                                Clic droit sur le canal → Copier l'ID
                            </div>
                        </div>

                        <div class="config-modal__actions">
                            <button type="button" class="btn btn--secondary" id="config-cancel">
                                <i class="fas fa-times" aria-hidden="true"></i>
                                Annuler
                            </button>
                            <button type="submit" class="btn btn--primary" id="config-save">
                                <i class="fas fa-save" aria-hidden="true"></i>
                                Sauvegarder
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Overlay de chargement -->
        <div class="loading-overlay" id="loading-overlay" aria-hidden="true">
            <div class="loading-spinner">
                <div class="spinner"></div>
                <p id="loading-text">Connexion en cours...</p>
            </div>
        </div>
    </div>

    <script>
        // État global de l'application
        const AppState = {
            // États possibles: 'not-configured', 'configured', 'connecting', 'connected', 'error'
            currentState: 'not-configured',
            isConfigured: false,
            socket: null,
            messageCount: 0,
            
            // Éléments DOM
            elements: {
                heroButton: null,
                statusIndicator: null,
                configModal: null,
                configButton: null,
                logsContent: null,
                messagesContainer: null,
                messageCount: null,
                connectionStatus: null,
                loadingOverlay: null
            },

            // Initialisation
            init() {
                this.cacheElements();
                this.initializeSocket();
                this.setupEventListeners();
                this.loadConfiguration();
            },

            // Cache des éléments DOM
            cacheElements() {
                this.elements.heroButton = document.getElementById('hero-button');
                this.elements.statusIndicator = document.getElementById('status-indicator');
                this.elements.configModal = document.getElementById('config-modal');
                this.elements.configButton = document.getElementById('config-button');
                this.elements.updateButton = document.getElementById('update-button');
                this.elements.updateCount = document.getElementById('update-count');
                this.elements.logsContent = document.getElementById('logs-content');
                this.elements.messagesContainer = document.getElementById('messages-container');
                this.elements.messageCount = document.getElementById('message-count');
                this.elements.connectionStatus = document.getElementById('connection-status');
                this.elements.loadingOverlay = document.getElementById('loading-overlay');
            },

            // Configuration Socket.IO
            initializeSocket() {
                this.socket = io();
                
                this.socket.on('connect', () => {
                    this.addLog('Connexion WebSocket établie', 'success');
                });

                this.socket.on('disconnect', () => {
                    this.addLog('Connexion WebSocket fermée', 'error');
                });

                this.socket.on('new_message', (data) => {
                    this.addMessage(data);
                });

                this.socket.on('status_change', (data) => {
                    this.updateState(data.status);
                    this.addLog(data.message, data.status === 'error' ? 'error' : 'success');
                });
            },

            // Configuration des événements
            setupEventListeners() {
                // Bouton principal
                this.elements.heroButton.addEventListener('click', () => this.handleHeroButtonClick());
                
                // Bouton de configuration
                this.elements.configButton.addEventListener('click', () => this.openConfigModal());
                
                // Bouton de mise à jour
                this.elements.updateButton.addEventListener('click', () => this.handleUpdateClick());
                
                // Modal de configuration
                document.getElementById('config-modal-close').addEventListener('click', () => this.closeConfigModal());
                document.getElementById('config-modal-backdrop').addEventListener('click', () => this.closeConfigModal());
                document.getElementById('config-cancel').addEventListener('click', () => this.closeConfigModal());
                document.getElementById('config-form').addEventListener('submit', (e) => this.handleConfigSubmit(e));
                
                // Gestion du clavier pour la modal
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape' && !this.elements.configModal.getAttribute('aria-hidden')) {
                        this.closeConfigModal();
                    }
                });
                
                // Vérifier les mises à jour périodiquement
                this.checkForUpdates();
                setInterval(() => this.checkForUpdates(), 300000); // Toutes les 5 minutes
            },

            // Gestion du clic sur le bouton principal
            handleHeroButtonClick() {
                switch (this.currentState) {
                    case 'not-configured':
                        this.openConfigModal();
                        break;
                    case 'configured':
                        this.startListening();
                        break;
                    case 'connected':
                        this.stopListening();
                        break;
                    default:
                        // États transitoires, ne rien faire
                        break;
                }
            },

            // Mise à jour de l'état de l'application
            updateState(newState) {
                this.currentState = newState;
                this.updateUI();
            },

            // Mise à jour de l'interface utilisateur
            updateUI() {
                this.updateHeroButton();
                this.updateStatusIndicator();
                this.updateConnectionStatus();
            },

            // Mise à jour du bouton principal
            updateHeroButton() {
                const button = this.elements.heroButton;
                const icon = button.querySelector('.hero-button__icon i');
                const title = button.querySelector('.hero-button__title');
                const subtitle = button.querySelector('.hero-button__subtitle');

                // Supprimer toutes les classes d'état
                button.className = 'hero-button';

                switch (this.currentState) {
                    case 'not-configured':
                        button.classList.add('hero-button--configure');
                        icon.className = 'fas fa-cog';
                        title.textContent = 'Configurer Discord Monitor';
                        subtitle.textContent = 'Commencez par configurer votre bot Discord';
                        button.disabled = false;
                        break;
                    
                    case 'configured':
                        button.classList.add('hero-button--start');
                        icon.className = 'fas fa-play';
                        title.textContent = 'Démarrer l\'écoute';
                        subtitle.textContent = 'Commencer la surveillance des messages';
                        button.disabled = false;
                        break;
                    
                    case 'connecting':
                        button.classList.add('hero-button--connecting');
                        icon.className = 'fas fa-spinner fa-spin';
                        title.textContent = 'Connexion en cours...';
                        subtitle.textContent = 'Connexion au serveur Discord';
                        button.disabled = true;
                        break;
                    
                    case 'connected':
                        button.classList.add('hero-button--stop');
                        icon.className = 'fas fa-stop';
                        title.textContent = 'Arrêter l\'écoute';
                        subtitle.textContent = 'Surveillance active - Cliquez pour arrêter';
                        button.disabled = false;
                        break;
                    
                    case 'error':
                        button.classList.add('hero-button--error');
                        icon.className = 'fas fa-exclamation-triangle';
                        title.textContent = 'Erreur de connexion';
                        subtitle.textContent = 'Cliquez pour réessayer';
                        button.disabled = false;
                        break;
                }
            },

            // Mise à jour de l'indicateur de statut
            updateStatusIndicator() {
                const indicator = this.elements.statusIndicator;
                const dot = indicator.querySelector('.status-dot');
                const text = indicator.querySelector('.status-text');

                // Supprimer toutes les classes d'état
                dot.className = 'status-dot';

                switch (this.currentState) {
                    case 'not-configured':
                        dot.classList.add('status-dot--disconnected');
                        text.textContent = 'Non configuré';
                        break;
                    
                    case 'configured':
                        dot.classList.add('status-dot--ready');
                        text.textContent = 'Prêt à démarrer';
                        break;
                    
                    case 'connecting':
                        dot.classList.add('status-dot--connecting');
                        text.textContent = 'Connexion...';
                        break;
                    
                    case 'connected':
                        dot.classList.add('status-dot--connected');
                        text.textContent = 'En écoute active';
                        break;
                    
                    case 'error':
                        dot.classList.add('status-dot--error');
                        text.textContent = 'Erreur';
                        break;
                }
            },

            // Mise à jour du statut de connexion
            updateConnectionStatus() {
                const status = this.elements.connectionStatus;
                
                switch (this.currentState) {
                    case 'connected':
                        status.textContent = 'En ligne';
                        status.className = 'connection-status connection-status--online';
                        break;
                    case 'connecting':
                        status.textContent = 'Connexion...';
                        status.className = 'connection-status connection-status--connecting';
                        break;
                    default:
                        status.textContent = 'Hors ligne';
                        status.className = 'connection-status connection-status--offline';
                        break;
                }
            },

            // Ouverture de la modal de configuration
            openConfigModal() {
                this.elements.configModal.setAttribute('aria-hidden', 'false');
                this.elements.configModal.classList.add('config-modal--open');
                
                // Focus sur le premier champ
                const firstInput = this.elements.configModal.querySelector('input');
                if (firstInput) {
                    setTimeout(() => firstInput.focus(), 100);
                }
                
                // Empêcher le scroll du body
                document.body.style.overflow = 'hidden';
            },

            // Fermeture de la modal de configuration
            closeConfigModal() {
                this.elements.configModal.setAttribute('aria-hidden', 'true');
                this.elements.configModal.classList.remove('config-modal--open');
                
                // Restaurer le scroll du body
                document.body.style.overflow = '';
                
                // Remettre le focus sur le bouton qui a ouvert la modal
                this.elements.configButton.focus();
            },

            // Gestion de la soumission du formulaire de configuration
            async handleConfigSubmit(event) {
                event.preventDefault();
                
                const formData = new FormData(event.target);
                const token = formData.get('token').trim();
                const guildId = formData.get('guild-id').trim();
                const channelId = formData.get('channel-id').trim();

                if (!token || !guildId || !channelId) {
                    this.showConfigAlert('Tous les champs sont requis', 'error');
                    return;
                }

                try {
                    this.showLoading('Sauvegarde de la configuration...');
                    
                    const response = await fetch('/api/discord/config', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            token: token,
                            guild_id: guildId,
                            channel_id: channelId
                        })
                    });

                    const result = await response.json();

                    if (response.ok) {
                        this.showConfigAlert('Configuration sauvegardée avec succès', 'success');
                        this.isConfigured = true;
                        this.updateState('configured');
                        this.addLog('Configuration sauvegardée', 'success');
                        
                        setTimeout(() => {
                            this.closeConfigModal();
                        }, 1500);
                    } else {
                        this.showConfigAlert(result.error || 'Erreur lors de la sauvegarde', 'error');
                    }
                } catch (error) {
                    this.showConfigAlert('Erreur de connexion', 'error');
                    this.addLog('Erreur: ' + error.message, 'error');
                } finally {
                    this.hideLoading();
                }
            },

            // Démarrage de l'écoute
            async startListening() {
                if (!this.isConfigured) {
                    this.openConfigModal();
                    return;
                }

                try {
                    this.updateState('connecting');
                    this.showLoading('Connexion au serveur Discord...');
                    this.addLog('Démarrage de l\'écoute...', 'info');

                    const response = await fetch('/api/discord/start', {
                        method: 'POST'
                    });

                    const result = await response.json();

                    if (response.ok) {
                        this.updateState('connected');
                        this.addLog('Écoute démarrée avec succès', 'success');
                    } else {
                        this.updateState('error');
                        this.addLog(result.error || 'Erreur lors du démarrage', 'error');
                    }
                } catch (error) {
                    this.updateState('error');
                    this.addLog('Erreur de connexion: ' + error.message, 'error');
                } finally {
                    this.hideLoading();
                }
            },

            // Arrêt de l'écoute
            async stopListening() {
                try {
                    this.showLoading('Arrêt de l\'écoute...');

                    const response = await fetch('/api/discord/stop', {
                        method: 'POST'
                    });

                    const result = await response.json();

                    if (response.ok) {
                        this.updateState('configured');
                        this.addLog('Écoute arrêtée', 'info');
                    } else {
                        this.addLog(result.error || 'Erreur lors de l\'arrêt', 'error');
                    }
                } catch (error) {
                    this.addLog('Erreur de connexion: ' + error.message, 'error');
                } finally {
                    this.hideLoading();
                }
            },

            // Chargement de la configuration
            async loadConfiguration() {
                try {
                    const response = await fetch('/api/discord/config');
                    const config = await response.json();
                    
                    if (config.guild_id) {
                        document.getElementById('guild-id').value = config.guild_id;
                    }
                    if (config.channel_id) {
                        document.getElementById('channel-id').value = config.channel_id;
                    }
                    
                    this.isConfigured = config.token_configured;
                    
                    if (this.isConfigured) {
                        this.updateState('configured');
                        this.addLog('Configuration chargée', 'success');
                    } else {
                        this.updateState('not-configured');
                        this.addLog('Configuration requise', 'info');
                    }
                } catch (error) {
                    this.addLog('Erreur lors du chargement de la configuration', 'error');
                }
            },

            // Ajout d'un message
            addMessage(messageData) {
                const container = this.elements.messagesContainer;
                
                // Supprimer le message "aucun message" s'il existe
                const noMessages = container.querySelector('#no-messages');
                if (noMessages) {
                    noMessages.remove();
                }

                // Créer l'élément message
                const messageElement = document.createElement('div');
                messageElement.className = 'message';
                messageElement.setAttribute('role', 'article');
                
                const avatar = messageData.author.avatar_url 
                    ? `<img src="${messageData.author.avatar_url}" alt="Avatar de ${messageData.author.name}" class="message__avatar">`
                    : `<div class="message__avatar message__avatar--text">${messageData.author.name.charAt(0).toUpperCase()}</div>`;

                const timestamp = new Date(messageData.timestamp).toLocaleString('fr-FR');

                messageElement.innerHTML = `
                    ${avatar}
                    <div class="message__content">
                        <div class="message__header">
                            <span class="message__author">${this.escapeHtml(messageData.author.name)}</span>
                            <time class="message__time" datetime="${messageData.timestamp}">${timestamp}</time>
                        </div>
                        <div class="message__text">${this.escapeHtml(messageData.content) || '<em>Message sans texte</em>'}</div>
                        ${messageData.attachments.length > 0 ? `
                            <div class="message__attachments">
                                ${messageData.attachments.map(att => `
                                    <div class="message__attachment">
                                        <i class="fas fa-paperclip" aria-hidden="true"></i>
                                        ${this.escapeHtml(att.filename)}
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                `;

                // Ajouter en haut de la liste
                container.insertBefore(messageElement, container.firstChild);

                // Limiter le nombre de messages affichés
                const messages = container.querySelectorAll('.message');
                if (messages.length > 50) {
                    messages[messages.length - 1].remove();
                }

                // Mettre à jour le compteur
                this.messageCount++;
                this.elements.messageCount.textContent = `${this.messageCount} message${this.messageCount > 1 ? 's' : ''}`;
            },

            // Ajout d'un log
            addLog(message, type = 'info') {
                const container = this.elements.logsContent;
                const timestamp = new Date().toLocaleTimeString('fr-FR');
                
                const logEntry = document.createElement('div');
                logEntry.className = `log-entry log-entry--${type}`;
                logEntry.innerHTML = `
                    <span class="log-time">[${timestamp}]</span>
                    <span class="log-message">${this.escapeHtml(message)}</span>
                `;

                container.insertBefore(logEntry, container.firstChild);

                // Limiter le nombre de logs
                const logs = container.children;
                if (logs.length > 10) {
                    logs[logs.length - 1].remove();
                }
            },

            // Affichage d'une alerte dans la modal de configuration
            showConfigAlert(message, type) {
                const alertsContainer = document.getElementById('config-alerts');
                const alert = document.createElement('div');
                alert.className = `alert alert--${type}`;
                alert.setAttribute('role', 'alert');
                
                const icon = type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-triangle' : 'info-circle';
                alert.innerHTML = `
                    <i class="fas fa-${icon}" aria-hidden="true"></i>
                    <span>${this.escapeHtml(message)}</span>
                `;

                alertsContainer.appendChild(alert);

                // Supprimer l'alerte après 5 secondes
                setTimeout(() => {
                    alert.remove();
                }, 5000);
            },

            // Affichage de l'overlay de chargement
            showLoading(text = 'Chargement...') {
                this.elements.loadingOverlay.setAttribute('aria-hidden', 'false');
                this.elements.loadingOverlay.classList.add('loading-overlay--visible');
                document.getElementById('loading-text').textContent = text;
            },

            // Masquage de l'overlay de chargement
            hideLoading() {
                this.elements.loadingOverlay.setAttribute('aria-hidden', 'true');
                this.elements.loadingOverlay.classList.remove('loading-overlay--visible');
            },

            // Vérification des mises à jour disponibles
            async checkForUpdates() {
                try {
                    const response = await fetch('/api/discord/update/status');
                    const updateStatus = await response.json();
                    
                    if (updateStatus.git_available && updateStatus.auto_update_enabled) {
                        // Toujours afficher le bouton
                        this.elements.updateButton.style.display = 'flex';
                        
                        if (updateStatus.updates_available > 0) {
                            // Des mises à jour sont disponibles
                            this.elements.updateButton.classList.remove('update-button--up-to-date');
                            this.elements.updateButton.classList.add('update-button--available');
                            this.elements.updateCount.style.display = 'flex';
                            this.elements.updateCount.textContent = updateStatus.updates_available;
                            this.elements.updateButton.title = `${updateStatus.updates_available} mise(s) à jour disponible(s) - Cliquez pour mettre à jour`;
                            this.elements.updateButton.disabled = false;
                        } else {
                            // Aucune mise à jour disponible
                            this.elements.updateButton.classList.remove('update-button--available');
                            this.elements.updateButton.classList.add('update-button--up-to-date');
                            this.elements.updateCount.style.display = 'none';
                            this.elements.updateButton.title = 'Application à jour - Cliquez pour vérifier les mises à jour';
                            this.elements.updateButton.disabled = false;
                        }
                    } else {
                        // Git non disponible ou mises à jour désactivées
                        this.elements.updateButton.style.display = 'flex';
                        this.elements.updateButton.classList.remove('update-button--available', 'update-button--up-to-date');
                        this.elements.updateButton.classList.add('update-button--disabled');
                        this.elements.updateCount.style.display = 'none';
                        this.elements.updateButton.title = 'Mises à jour non disponibles (Git manquant ou désactivé)';
                        this.elements.updateButton.disabled = true;
                    }
                } catch (error) {
                    console.log('Erreur lors de la vérification des mises à jour:', error);
                    // Afficher le bouton en état d'erreur
                    this.elements.updateButton.style.display = 'flex';
                    this.elements.updateButton.classList.remove('update-button--available', 'update-button--up-to-date');
                    this.elements.updateButton.classList.add('update-button--error');
                    this.elements.updateCount.style.display = 'none';
                    this.elements.updateButton.title = 'Erreur lors de la vérification des mises à jour';
                    this.elements.updateButton.disabled = true;
                }
            },

            // Gestion du clic sur le bouton de mise à jour
            async handleUpdateClick() {
                // Si le bouton est désactivé, ne rien faire
                if (this.elements.updateButton.disabled) {
                    return;
                }

                // Si aucune mise à jour n'est disponible, forcer une vérification
                if (this.elements.updateButton.classList.contains('update-button--up-to-date')) {
                    this.addLog('Vérification forcée des mises à jour...', 'info');
                    await this.checkForUpdates();
                    
                    // Si toujours aucune mise à jour après vérification
                    if (this.elements.updateButton.classList.contains('update-button--up-to-date')) {
                        this.addLog('Aucune mise à jour disponible', 'info');
                        return;
                    }
                }

                if (!confirm('Êtes-vous sûr de vouloir mettre à jour l\'application ? Cela redémarrera le service.')) {
                    return;
                }

                try {
                    this.showLoading('Mise à jour en cours...');
                    this.addLog('Démarrage de la mise à jour...', 'info');
                    
                    // Désactiver le bouton pendant la mise à jour
                    this.elements.updateButton.disabled = true;

                    const response = await fetch('/api/discord/update', {
                        method: 'POST'
                    });

                    const result = await response.json();

                    if (response.ok) {
                        this.addLog('Mise à jour effectuée avec succès', 'success');
                        
                        // Recharger la page après un délai
                        setTimeout(() => {
                            this.addLog('Rechargement de la page...', 'info');
                            window.location.reload();
                        }, 2000);
                    } else {
                        this.addLog(result.error || 'Erreur lors de la mise à jour', 'error');
                        this.elements.updateButton.disabled = false;
                    }
                } catch (error) {
                    this.addLog('Erreur de connexion lors de la mise à jour: ' + error.message, 'error');
                    this.elements.updateButton.disabled = false;
                } finally {
                    this.hideLoading();
                }
            },

            // Fonction utilitaire pour échapper le HTML
            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
        };

        // Initialisation de l'application
        document.addEventListener('DOMContentLoaded', () => {
            AppState.init();
        });
    </script>
</body>
</html>

